<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <title>Grasp2 Inventory</title>
    <style>

        .imgContainer {
          overflow: hidden;
        }
        .grid {
          display: -webkit-box;
          display: -webkit-flex;
          display: -ms-flexbox;
          display: flex;
          -webkit-flex-wrap: wrap;
              -ms-flex-wrap: wrap;
                  flex-wrap: wrap;
        }


    </style>
    <script>

        // websocket for handling redis pubsub
        var socket = new WebSocket("ws://128.148.110.89:7379/.json");
        socket.onopen = function() {
            socket.send(JSON.stringify(["SUBSCRIBE", "WebClient"]));
        };
        socket.onerror=function(event){
            document.getElementById("redisServerConnected").style.color = "red";
            document.getElementById("redisServerConnected").innerHTML = "No Connection";
        }
        socket.onmessage = function(evt)
        {
            //console.log(evt.data);
            try {
                var parsed = JSON.parse(JSON.parse(evt.data).SUBSCRIBE[2]);
                console.log('message is from grasp_server');
                if (parsed == '1') {
                    document.getElementById("redisServerConnected").style.color = "green";
                    document.getElementById("redisServerConnected").innerHTML = "Connected";
                } else {
                    handlePub(parsed);
                }
            }
            catch(err) {
                //console.log('message is from mpr121.c');
                //console.log(JSON.parse(evt.data).SUBSCRIBE[2]);
                message = JSON.parse(evt.data).SUBSCRIBE[2];
                handleMPR121(message);

            }


        };

        // Unsubscribe from redis when you close the window. otherwise it will crash the server.
        window.onbeforeunload = function() {
            socket.send(JSON.stringify(["UNSUBSCRIBE", "WebClient"]));
            return null;
        };

        function createGrid(cols,rows) {
            // Make a container for all necessary locations
            for(var i =1; i<= (cols * rows); i++){
              $('#target').append($('<div/>', { id: 'r' + i,class:"imgContainer"}));
              $('#r' + i).append($('<img>',{id: 'img' + i, title: 'eys', src:'/SVGs/blob2002.dgz_0.0132_10_6_2_3_25_0_1_1.svg'}))
            }

            // Size all the images and restructure it into a grid shape
            sizeGrid(cols,rows);
        }

        function sizeGrid(desired_cols, desired_rows) {
            // Size all the images and restructure it into a grid shape
            var window_width = $(window).width();
            var window_height = $(window).height() - 31;                                // Subtract 31 for header stuff
            var max_row_height = Math.round(window_height/desired_rows)*.96;            // tallest row which would fit all rows on screen
            var max_col_width = Math.round(window_width/desired_cols)*.96;              // widest col which would fit all cols on screen
            var edge_size = Math.min(max_row_height, max_col_width);                    // we'll use squares that will fit all rows and all cols
            var total_width = edge_size * desired_cols;                                 // width of all our columns

            $('.imgContainer').css("width", edge_size);                                 // set width of each image container
            $('.imgContainer').css("height", edge_size);                                // set height of each image container
            $('.imgContainer img').css("width", edge_size * 4.5);                       // scale svg
            $('.imgContainer img').css("margin-left", edge_size * -1.85);               // cut off some from the left
            $('.imgContainer img').css("margin-top", edge_size * -1.1);                 // cut off some from the top
            $('.grid').css("max-width" , total_width + "px");                           // set width of entire grid, determines when images will get stuck on the next row
        }

        function changeImage(addr) {
            //var addr = "/SVGs/blob2001.dgz_0.0132_10_6_2_3_25_0_1_1.svg";
            document.getElementById("img1").src = addr;
            document.getElementById("img1").title = addr;
        }

    </script>
</head>
<body onload="createGrid(7,12)" onresize="sizeGrid(7,12)">
<div class="container">

    <div class="form-group row mt-10">
        <div class="input-group mb-1 col-6">
            <div class="input-group-prepend">
                <span class="input-group-text">Grasp Server IP</span>
            </div>
            <input type="text" class="form-control col-4" value="128.148.110.89:8888" id="GraspIP">
            <div class="input-group-append">
                <button class="btn btn-outline-dark disabled" id="graspServerConnected">Connecting...</button>
            </div>
        </div>
        <div class="input-group mb-1 col-6">
            <div class="input-group-prepend">
                <span class="input-group-text">webdis Server IP</span>
            </div>
            <input type="text" class="form-control col-4" value="128.148.110.89:7379" id="RedisIP">
            <div class="input-group-append">
                <button class="btn btn-outline-dark disabled" id="redisServerConnected">Connecting...</button>
            </div>
        </div>
    </div>
</div>

<div class="grid" id="target"></div>

<button type="button" onclick="changeImage('/SVGs/blob2001.dgz_0.0132_10_6_2_3_25_0_1_1.svg')">Click Me!</button>
</body>
</html>