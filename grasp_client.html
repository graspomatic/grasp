<!DOCTYPE html>
<html>
<head>
    <title>Graspomatic 2 Manual control</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


    <style>
        .switch {
          position: relative;
          display: inline-block;
          width: 300px;
          height: 45px;
        }

        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          -webkit-transition: .4s;
          transition: .4s;
          border-radius: 4px;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 35px;
          width: 26px;
          left: 4px;
          bottom: 5px;
          background-color: white;
          -webkit-transition: .4s;
          transition: .4s;
          border-radius: 2px;
        }

        .magnetleft:after
        {
         content:'Left Magnet';
         color: white;
         display: block;
         position: absolute;
         transform: translate(-50%,-50%);
         top: 50%;
         left: 50%;
         font-size: 20px;
         font-family: Verdana, sans-serif;
        }

        .magnetright:after
        {
         content:'Right Magnet';
         color: white;
         display: block;
         position: absolute;
         transform: translate(-50%,-50%);
         top: 50%;
         left: 50%;
         font-size: 20px;
         font-family: Verdana, sans-serif;
        }



        input:checked + .slider {
          background-color: #2196F3;
        }

        input:focus + .slider {
          box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
          -webkit-transform: translateX(266px);
          -ms-transform: translateX(266px);
          transform: translateX(266px);
        }

        /* arms */
        .leftcustom{
           display:none;
        }
        .rightcustom{
           display:none;
        }


    </style>

    <script>

    $(document).ready(function() {

        // ------------- arms ---------------
        // Change options shown to user
        $('select[name="leftarmsettingtype"]').on('change',function(){
           if($(this).val()=="Prescribed") {
                $('.leftcustom').hide();
                $('.leftprescribed').show();
           } else {
                $('.leftprescribed').hide();
                $('.leftcustom').show();
           }
        });

        $('select[name="rightarmsettingtype"]').on('change',function(){
           if($(this).val()=="Prescribed") {
                $('.rightcustom').hide();
                $('.rightprescribed').show();
           } else {
                $('.rightprescribed').hide();
                $('.rightcustom').show();
           }
        });

        // Handle button press

        $('#moveleftarm').click(function() {
            var ip = document.getElementById("GraspIP").value;
            var choice = document.getElementById("leftarmsettingtype").value;
            if (choice == 'Prescribed') {
                var prescribedchoice = document.getElementById("leftPrescribedSetting").value;
            } else {
                var m1 = document.getElementById("leftMotor1").value;
                var m2 = document.getElementById("leftMotor2").value;
                var m3 = document.getElementById("leftMotor3").value;
            }
        });

        // ------------- magnets ---------------
        $('#magLeft').change(function() {
            var ip = document.getElementById("GraspIP").value;
            if(this.checked) {
                $.get("http://" + ip, { "function":"magnets", "left_status":"1" });
            } else {
               $.get("http://" + ip, { "function":"magnets", "left_status":"0" });
            }
        });

        $('#magRight').change(function() {
            var ip = document.getElementById("GraspIP").value;
            if(this.checked) {
                $.get("http://" + ip, { "function":"magnets", "right_status":"1" });
            } else {
               $.get("http://" + ip, { "function":"magnets", "right_status":"0" });
            }
        });


        // ------------- x-y motors  ---------------
        var xlocationchange = document.getElementById("xlocation");
        xlocationchange.addEventListener("keyup", function(event) {
              if (event.keyCode === 13) {
                   event.preventDefault();
                   document.getElementById("movexaxis").click();
              }
        });

        var ylocationchange = document.getElementById("ylocation");
        ylocationchange.addEventListener("keyup", function(event) {
              if (event.keyCode === 13) {
                   event.preventDefault();
                   document.getElementById("moveyaxis").click();
              }
        });

        $('#movexaxis').click(function() {
            var ip = document.getElementById("GraspIP").value;
            var xloc = document.getElementById("xlocation").value;
            var cmd = { "function":"move_xy_to_location", "axis":"x", "location":xloc };
            $.get("http://" + ip, cmd, function(data) {
            })
              .done(function(data) {
                console.log(data.GET);
                alert('whatwhat');
              })
              .fail(function(data) {
                console.log(data);
                alert( "error" );
                alert( Object.keys(data) );
              })
              .always(function(data) {
                alert( data );
              });
        });

        $('#moveyaxis').click(function() {
            var ip = document.getElementById("GraspIP").value;
            var yloc = document.getElementById("ylocation").value;
            var cmd = { "function":"move_xy_to_location", "axis":"y", "location":yloc };
            $.get("http://" + ip, cmd);


            $.get("http://128.148.110.89:7379/SET/foo/whawha"); // works

            var jqxhr = $.get( "http://128.148.110.89:7379/GET/foo", function(data) {
            })
              .done(function(data) {
                console.log(data.GET);
              })
              .fail(function() {
                alert( "error" );
              })
              .always(function() {
              });


        });


        // ------------------ manual command entry ----------------------------

        var manualcontrol = document.getElementById("manualcontrol");
        manualcontrol.addEventListener("keyup", function(event) {
              if (event.keyCode === 13) {
                    var ip = document.getElementById("GraspIP").value;
                    var query = document.getElementById("manualcontrol").value;
                    var js = JSON.parse('{"' + decodeURI(query).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}');
                    $.get("http://" + ip, js, function() {
                    })
                      .done(function(data, textStatus, jqXHR) {
                        console.log(jqXHR.statusText);
                      })
                      .fail(function(data) {
                        alert( "manualcontrol failed" );
                      });
              }
        });


        // websocket for handling redis pubsub

        var socket = new WebSocket("ws://128.148.110.89:7379/.json");
            socket.onopen = function() {
                socket.send(JSON.stringify(["SUBSCRIBE", "WebClient"]));
            };
            socket.onerror=function(event){
                document.getElementById("redisServerConnected").style.color = "red";
                document.getElementById("redisServerConnected").innerHTML = "No Connection";
            }
            socket.onmessage = function(evt)
            {
                var parsed = JSON.parse(JSON.parse(evt.data).SUBSCRIBE[2]);

                if (parsed == '1') {
                    document.getElementById("redisServerConnected").style.color = "green";
                    document.getElementById("redisServerConnected").innerHTML = "Connected";
                } else {
                    handlePub(parsed);
                }
            };

        // Handle published messages from redis

        armPos = ['pick', 'prep-pick', 'prep-present', 'present'];

        function handlePub(message) {
            console.log(message);
            for (key in message) {
                if (key == 'xpos') {
                    document.getElementById("xlocation").value = message[key];
                } else if (key == 'ypos') {
                    document.getElementById("ylocation").value = message[key];
                } else if (key == 'leftmag') {
                    document.getElementById("magLeft").checked = parseInt(message[key]);
                } else if (key == 'rightmag') {
                    document.getElementById("magRight").checked = parseInt(message[key]);
                } else if (key == 'leftsensor') {
                    if (message[key] == 'dc') {
                        document.getElementById("leftObjectAttached").value = '';
                        document.getElementById("leftObjectUpdating").style.color = "red";
                        document.getElementById("leftObjectUpdating").innerHTML = "Stale";
                    } else {
                        document.getElementById("leftObjectAttached").value = message[key];
                        document.getElementById("leftObjectUpdating").style.color = "green";
                        document.getElementById("leftObjectUpdating").innerHTML = "Live";
                    }
                } else if (key == 'rightsensor') {
                    if (message[key] == 'dc') {
                        document.getElementById("rightObjectAttached").value = '';
                        document.getElementById("rightObjectUpdating").style.color = "red";
                        document.getElementById("rightObjectUpdating").innerHTML = "Stale";
                    } else {
                        document.getElementById("rightObjectAttached").value = message[key];
                        document.getElementById("rightObjectUpdating").style.color = "green";
                        document.getElementById("rightObjectUpdating").innerHTML = "Live";
                    }
                } else if (key == 'leftarm') {
                    //decide if they're sending a prescribed position or triplet
                    if (armPos.includes(message[key])) {
                        document.getElementById("leftarmsettingtype").selectedIndex = 0;
                        $('select[name="leftarmsettingtype"]').change();
                        document.getElementById("leftPrescribedSetting").value = message[key];
                    } else {
                        document.getElementById("leftarmsettingtype").selectedIndex = 1;
                        $('select[name="leftarmsettingtype"]').change();
                        var vals = message[key].split(',');
                        if (vals.length == 3) {
                            document.getElementById("leftMotor1").value = vals[0];
                            document.getElementById("leftMotor2").value = vals[1];
                            document.getElementById("leftMotor3").value = vals[2];
                        } else {
                            console.log('sent wrong number of values. should be leftarm=12,34,56');
                        }
                    }

                } else if (key == 'rightarm') {
                    //decide if they're sending a prescribed position or triplet
                    if (armPos.includes(message[key])) {
                        document.getElementById("rightarmsettingtype").selectedIndex = 0;
                        document.getElementById("rightPrescribedSetting").value = message[key];
                        $('select[name="rightarmsettingtype"]').change();
                    } else {
                        document.getElementById("rightarmsettingtype").selectedIndex = 1;
                        $('select[name="rightarmsettingtype"]').change();
                        var vals = message[key].split(',');
                        if (vals.length == 3) {
                            document.getElementById("rightMotor1").value = vals[0];
                            document.getElementById("rightMotor2").value = vals[1];
                            document.getElementById("rightMotor3").value = vals[2];
                        } else {
                            console.log('sent wrong number of values. should be rightarm=12,34,56');
                        }
                    }
                } //end if
            } // end for loop
        } // end handlePub

        // Unsubscribe when you close the window. otherwise it will crash the server.
        window.onbeforeunload = function() {
            socket.send(JSON.stringify(["UNSUBSCRIBE", "WebClient"]));
            return null;
        };





    });






    </script>



</head>

<body>

<div class="container">

    <div class="form-group row mt-10">
        <div class="input-group mb-1 col-6">
            <div class="input-group-prepend">
                <span class="input-group-text">Grasp Server IP</span>
            </div>
            <input type="text" class="form-control col-4" value="128.148.110.89:8888" id="GraspIP">
            <div class="input-group-append">
                <button class="btn btn-outline-dark disabled" id="graspServerConnected">Connecting...</button>
            </div>
        </div>
        <div class="input-group mb-1 col-6">
            <div class="input-group-prepend">
                <span class="input-group-text">Redis Server IP</span>
            </div>
            <input type="text" class="form-control col-4" value="128.148.110.89:7379" id="RedisIP">
            <div class="input-group-append">
                <button class="btn btn-outline-dark disabled" id="redisServerConnected">Connecting...</button>
            </div>
        </div>
    </div>


    <!--Sensor feedback-->
    <div class="form-group row mb-0">
        <div class="input-group mb-1 col-6">
            <div class="input-group-prepend">
                <span class="input-group-text">Left Sensor</span>
            </div>
            <input type="text" id="leftObjectAttached" class="form-control" placeholder="ObjectID">
            <div class="input-group-append">
                <button class="btn btn-outline-dark disabled" id="leftObjectUpdating">no pub</button>
            </div>

        </div>
        <div class="input-group mb-1 col-6">
             <div class="input-group-prepend">
                <span class="input-group-text">Right Sensor</span>
            </div>
            <input type="text" id="rightObjectAttached" class="form-control" placeholder="ObjectID">
            <div class="input-group-append">
                <button class="btn btn-outline-dark disabled" id="rightObjectUpdating">no pub</button>
            </div>


        </div>


    </div>



    <!--Arm control-->
    <div class="form-group row mb-0">
        <div class="input-group mb-1 col-6">
            <div class="input-group-prepend">
                <span class="input-group-text" id="">Left Arm</span>
            </div>
            <select class="form-control" name="leftarmsettingtype" id="leftarmsettingtype">
                  <option>Prescribed</option>
                  <option>Custom</option>
            </select>
            <select class="form-control leftprescribed" id="leftPrescribedSetting">
                  <option>present</option>
                  <option>prep-present</option>
                  <option>prep-pick</option>
                  <option>pick</option>
            </select>
            <input type="text" id="leftMotor1" class="form-control leftcustom" placeholder="motor1 setting">
            <input type="text" id="leftMotor2" class="form-control leftcustom" placeholder="motor2 setting">
            <input type="text" id="leftMotor3" class="form-control leftcustom" placeholder="motor3 setting">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" id="moveleftarm">Move</button>
            </div>
        </div>

        <div class="input-group mb-1 col-6">
            <div class="input-group-prepend">
                <span class="input-group-text" id="">Right Arm</span>
            </div>
            <select class="form-control" name="rightarmsettingtype" id="rightarmsettingtype">
                  <option>Prescribed</option>
                  <option>Custom</option>
            </select>
            <select class="form-control rightprescribed" id="rightPrescribedSetting">
                  <option>present</option>
                  <option>prep-present</option>
                  <option>prep-pick</option>
                  <option>pick</option>
            </select>
            <input type="text" id="rightMotor1" class="form-control rightcustom" placeholder="motor1 setting">
            <input type="text" id="rightMotor2" class="form-control rightcustom" placeholder="motor2 setting">
            <input type="text" id="rightMotor3" class="form-control rightcustom" placeholder="motor3 setting">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" id="moverightarm">Move</button>
            </div>
        </div>
    </div>



    <!--Magnets-->
    <div class="form-group row mb-5">
        <div class="input-group col-6 mb-10">
            <label class="switch mx-auto">
              <input type="checkbox" id="magLeft">
              <span class="slider"></span>
              <span class="magnetleft"></span>
            </label>
        </div>
        <div class="input-group col-6 mb-5">
            <label class="switch mx-auto">
              <input type="checkbox" id="magRight">
              <span class="slider"></span>
              <span class="magnetright"></span>
            </label>
        </div>
    </div>



    <!--X/Y control-->
    <div class="input-group col-4 mb-2">
        <div class="input-group-prepend">
            <span class="input-group-text">X-Axis Position</span>
        </div>
        <input type="text" id="xlocation" class="form-control" placeholder="0">
        <div class="input-group-append">
            <button class="btn btn-primary" id="movexaxis" data-id='{ "function":"move_xy_to_location", "axis":"x" }'>Move</button>
        </div>
    </div>
    <div class="input-group col-4 mb-2">
        <div class="input-group-prepend">
            <span class="input-group-text">Y-Axis Position</span>
        </div>
        <input type="text" id="ylocation" class="form-control" placeholder="0">
        <div class="input-group-append">
            <button class="btn btn-primary" id="moveyaxis">Move</button>
        </div>
    </div>




    <!--Manual control-->
    <div class="input-group col-16 mt-5">
        <input type="text" id="manualcontrol" class="form-control" placeholder="function=a&prop=b">
    </div>






</div>








</body>
</html>



